<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>DB Log 3D Vector Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; }
        .description { border: 1px solid #ccc; padding: 15px; border-radius: 5px; background-color: #f9f9f9; margin-top: 20px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; }
    </style>
</head>
<body>
<h1>DB Log 3D Vector Dashboard</h1>
<div id="plotDiv" style="width:100%; height:70vh;"></div>

<div class="description">
    <h2>3D Vector 의미</h2>
    <p>각 점은 하나의 DB 쿼리(Query)를 3차원 공간에 표현한 것입니다. 정상적인 쿼리들은 주로 원점 근처에 밀집되어 '베이스라인 클러스터'를 형성합니다.</p>
    <ul>
        <li><b>X축 (Execution Time)</b>: 쿼리 실행에 걸린 시간 (ms). X값이 큰 점은 성능 저하를 유발하는 느린 쿼리일 수 있습니다.</li>
        <li><b>Y축 (Result Row Count)</b>: 쿼리가 반환한 데이터의 행(Row) 수. Y값이 비정상적으로 큰 점은 대량의 데이터 유출 시도일 수 있습니다.</li>
        <li><b>Z축 (Query Interval)</b>: 같은 세션 내에서 이전 쿼리와의 시간 간격 (ms). Z값이 0에 가까운 점들이 연속적으로 나타나면, 자동화된 툴에 의한 빠른 공격(e.g., Brute-force)을 의심할 수 있습니다.</li>
    </ul>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const vectorData = /*[[${vectorData}]]*/ [];

    const xData = vectorData.map(d => d.x);
    const yData = vectorData.map(d => d.y);
    const zData = vectorData.map(d => d.z);
    const textData = vectorData.map(d => 
        `Query: ${d.text}<br>X (Time): ${d.x}ms<br>Y (Rows): ${d.y}<br>Z (Interval): ${d.z}ms`
    );

    const trace = {
        x: xData,
        y: yData,
        z: zData,
        text: textData,
        hoverinfo: 'text',
        mode: 'markers',
        marker: {
            size: 5,
            color: zData,
            colorscale: 'Viridis',
            opacity: 0.8,
            colorbar: {
                title: 'Query Interval (ms)'
            }
        },
        type: 'scatter3d'
    };

    const layout = {
        title: 'DB Query 3D Vector Space',
        scene: {
            xaxis: {title: 'Execution Time (ms)'},
            yaxis: {title: 'Result Row Count'},
            zaxis: {title: 'Query Interval (ms)'}
        },
        margin: {
            l: 0, r: 0, b: 0, t: 40
        }
    };

    Plotly.newPlot('plotDiv', [trace], layout);
    /*]]>*/
</script>
</body>
</html>
